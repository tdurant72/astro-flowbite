---
import Layout from "../layouts/Layout.astro";
import { getCollection } from "astro:content";

import siteData from "../data/site.json";
import YouTubeCard from "@/components/custom/YouTubeCard.astro";
import ArticleCard from "@/components/custom/ArticleCard.astro";

const posts = (await getCollection("posts")).sort(
  (a, b) =>
    new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime(),
);

// Fetch YouTube Latest Posts
const YOUTUBE_CHANNEL_ID = "UCzwtlB5gFnZdyzXnebB3sFw";
const YOUTUBE_RSS_URL = `https://www.youtube.com/feeds/videos.xml?channel_id=${YOUTUBE_CHANNEL_ID}`;

let youtubeVideos = [];
try {
  const response = await fetch(YOUTUBE_RSS_URL);
  const xml = await response.text();

  // Simple regex parsing for the latest 3 videos
  const videoIds = [...xml.matchAll(/<yt:videoId>([^<]+)<\/yt:videoId>/g)].map(
    (m) => m[1],
  );
  const rawTitles = [...xml.matchAll(/<title>([^<]+)<\/title>/g)]
    .slice(1)
    .map((m) => m[1]);

  youtubeVideos = videoIds.slice(0, 3).map((id, index) => ({
    id,
    title: rawTitles[index] || "YouTube Video",
  }));
} catch (error) {
  console.error("Error fetching YouTube feed:", error);
}
---

<Layout
  title="Sublime UX Blog"
  description={siteData.siteDescription}
  image={siteData.image.src}
>
  <div class="flex flex-col gap-4 md:gap-8 items-center justify-center">
    <h1 class="text-primaryDrk font-bold text-3xl pt-[8vh]">Sublime UX Blog</h1>
    <p class="text-primaryDrk font-bold text-2xl">YouTube Channel Posts</p>
    <div
      id="youtubePosts"
      class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-6xl px-4"
    >
      {
        youtubeVideos.map((video) => (
          <YouTubeCard videoid={video.id} title={video.title} />
        ))
      }
    </div>
    <p class="text-primaryDrk font-bold text-2xl">Sublime UX Writing</p>
    <div class="grid grid-cols-3 gap-4">
      {
        posts.map((article) => {
          return (
            <div class="grid col-span-3 md:col-span-1">
              <ArticleCard article={article} />
            </div>
          );
        })
      }
    </div>
  </div>
</Layout>
<!--  -->
